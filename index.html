<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آنالایزر طیف صوتی استریو - موبایل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        header {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #ff6b6b, #ffa86b, #ffe66d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .description {
            font-size: 0.95rem;
            opacity: 0.9;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .permission-guide {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .permission-guide h3 {
            margin-bottom: 10px;
            color: #ffe66d;
        }
        
        .permission-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .step-number {
            background: #6a11cb;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .analyzer-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background: linear-gradient(90deg, #555, #777);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .visualizer {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .channel-label {
            position: absolute;
            top: 12px;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.4);
        }
        
        .left-channel {
            left: 15px;
            color: #ff6b6b;
        }
        
        .right-channel {
            right: 15px;
            color: #4ecdc4;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            width: 100%;
        }
        
        .info-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .info-box h3 {
            margin-bottom: 8px;
            color: #ffe66d;
            font-size: 1rem;
        }
        
        .info-content {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .frequency-bands {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .mobile-warning {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-warning i {
            color: #ff6b6b;
            font-size: 1.2rem;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            opacity: 0.8;
            font-size: 0.85rem;
        }
        
        /* طراحی واکنش‌گرا برای موبایل */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .description {
                font-size: 0.9rem;
            }
            
            .visualizer {
                height: 250px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 280px;
                justify-content: center;
            }
            
            .channel-label {
                font-size: 0.9rem;
            }
            
            .info-content {
                font-size: 1.1rem;
            }
        }
        
        /* افکت‌های ویژه برای موبایل */
        .touch-effect {
            position: relative;
            overflow: hidden;
        }
        
        .touch-effect:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .touch-effect:focus:after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            20% {
                transform: scale(50, 50);
                opacity: 1;
            }
            100% {
                transform: scale(100, 100);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>آنالایزر طیف صوتی استریو - موبایل</h1>
            <p class="description">آنالایزر پیشرفته برای تحلیل طیف فرکانسی صدا به صورت استریو - بهینه‌شده برای موبایل</p>
        </header>
        
        <div class="permission-guide">
            <h3><i class="fas fa-info-circle"></i> راهنمای دسترسی به میکروفون</h3>
            <div class="permission-steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>روی دکمه "شروع تحلیل صدا" کلیک کنید</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>پنجره درخواست دسترسی به میکروفون را تأیید کنید</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>در صورت عدم مشاهده پنجره، آیکون قفل در نوار آدرس مرورگر را بررسی کنید</div>
                </div>
            </div>
        </div>
        
        <div class="analyzer-container">
            <div class="controls">
                <button id="startBtn" class="btn touch-effect">
                    <i class="fas fa-microphone"></i>
                    شروع تحلیل صدا
                </button>
                <button id="stopBtn" class="btn touch-effect" disabled>
                    <i class="fas fa-stop"></i>
                    توقف تحلیل
                </button>
                <button id="simulateBtn" class="btn touch-effect">
                    <i class="fas fa-play"></i>
                    شبیه‌سازی صدا
                </button>
            </div>
            
            <div class="visualizer">
                <span class="channel-label left-channel">کانال چپ</span>
                <span class="channel-label right-channel">کانال راست</span>
                <canvas id="visualizerCanvas"></canvas>
            </div>
            
            <div class="info-panel">
                <div class="info-box">
                    <h3>فرکانس غالب</h3>
                    <div class="info-content">
                        <span id="dominantFrequency">0 Hz</span>
                    </div>
                    <div class="frequency-bands">
                        <span>باس: 20-250Hz</span>
                        <span>مید: 250-4kHz</span>
                        <span>تربل: 4k-20kHz</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>سطح شدت صوت</h3>
                    <div class="info-content">
                        <span id="volumeLevel">-∞ dB</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>حالت پردازش</h3>
                    <div class="info-content">
                        <span id="processingMode">آماده</span>
                    </div>
                </div>
            </div>
            
            <div class="mobile-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>در برخی مرورگرهای موبایل، برای دسترسی به میکروفون باید به صورت دستی مجوزها را فعال کنید.</div>
            </div>
        </div>
        
        <footer>
            <p>اپلیکیشن هیبریدی آنالایزر طیف صوتی | طراحی شده برای موبایل</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const simulateBtn = document.getElementById('simulateBtn');
            const dominantFrequency = document.getElementById('dominantFrequency');
            const volumeLevel = document.getElementById('volumeLevel');
            const processingMode = document.getElementById('processingMode');
            const canvas = document.getElementById('visualizerCanvas');
            const ctx = canvas.getContext('2d');
            
            let audioContext;
            let analyserLeft;
            let analyserRight;
            let dataArrayLeft;
            let dataArrayRight;
            let animationId;
            let isAnalyzing = false;
            let isSimulating = false;
            let oscillator;
            
            // تنظیم اندازه Canvas
            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // بررسی پشتیبانی از Audio API
            function checkAudioSupport() {
                if (!(window.AudioContext || window.webkitAudioContext)) {
                    alert('مرورگر شما از Web Audio API پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.');
                    return false;
                }
                return true;
            }
            
            // شروع تحلیل صدا
            startBtn.addEventListener('click', async function() {
                if (isAnalyzing) return;
                if (!checkAudioSupport()) return;
                
                try {
                    // دسترسی به میکروفون
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    }).catch(err => {
                        console.error('Error accessing microphone:', err);
                        showPermissionError();
                        throw err;
                    });
                    
                    // ایجاد context صوتی
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    
                    // ایجاد Splitter برای جداسازی کانال‌های استریو
                    const splitter = audioContext.createChannelSplitter(2);
                    source.connect(splitter);
                    
                    // ایجاد آنالایزر برای کانال چپ
                    analyserLeft = audioContext.createAnalyser();
                    analyserLeft.fftSize = 1024;
                    analyserLeft.smoothingTimeConstant = 0.8;
                    splitter.connect(analyserLeft, 0);
                    
                    // ایجاد آنالایزر برای کانال راست
                    analyserRight = audioContext.createAnalyser();
                    analyserRight.fftSize = 1024;
                    analyserRight.smoothingTimeConstant = 0.8;
                    splitter.connect(analyserRight, 1);
                    
                    // ایجاد آرایه‌های داده
                    dataArrayLeft = new Uint8Array(analyserLeft.frequencyBinCount);
                    dataArrayRight = new Uint8Array(analyserRight.frequencyBinCount);
                    
                    // تغییر وضعیت دکمه‌ها
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    simulateBtn.disabled = true;
                    isAnalyzing = true;
                    isSimulating = false;
                    
                    processingMode.textContent = "درحال تحلیل میکروفون";
                    
                    // شروع انیمیشن
                    animate();
                    
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    // در صورت خطا، حالت شبیه‌سازی را فعال می‌کنیم
                    simulateBtn.click();
                }
            });
            
            // نمایش خطای دسترسی
            function showPermissionError() {
                alert('دسترسی به میکروفون داده نشد. لطفاً:\n\n1. مجوز دسترسی به میکروفون را در مرورگر خود تأیید کنید\n2. از مرورگرهای مدرن مانند Chrome یا Firefox استفاده کنید\n3. از حالت حریم خصوصی خارج شوید\n\nدر حال حاضر حالت شبیه‌سازی فعال خواهد شد.');
            }
            
            // شروع شبیه‌سازی صدا
            simulateBtn.addEventListener('click', function() {
                if (isSimulating) return;
                if (!checkAudioSupport()) return;
                
                try {
                    // ایجاد context صوتی
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    // ایجاد نوسان‌ساز برای شبیه‌سازی صدا
                    oscillator = audioContext.createOscillator();
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                    
                    // ایجاد آنالایزر برای کانال چپ
                    analyserLeft = audioContext.createAnalyser();
                    analyserLeft.fftSize = 1024;
                    analyserLeft.smoothingTimeConstant = 0.8;
                    oscillator.connect(analyserLeft);
                    
                    // ایجاد آنالایزر برای کانال راست
                    analyserRight = audioContext.createAnalyser();
                    analyserRight.fftSize = 1024;
                    analyserRight.smoothingTimeConstant = 0.8;
                    oscillator.connect(analyserRight);
                    
                    // ایجاد آرایه‌های داده
                    dataArrayLeft = new Uint8Array(analyserLeft.frequencyBinCount);
                    dataArrayRight = new Uint8Array(analyserRight.frequencyBinCount);
                    
                    // شروع نوسان‌ساز
                    oscillator.start();
                    
                    // تغییر وضعیت دکمه‌ها
                    startBtn.disabled = false;
                    stopBtn.disabled = false;
                    simulateBtn.disabled = true;
                    isAnalyzing = false;
                    isSimulating = true;
                    
                    processingMode.textContent = "حالت شبیه‌سازی";
                    
                    // شروع انیمیشن
                    animate();
                    
                } catch (error) {
                    console.error('Error in simulation mode:', error);
                    alert('خطا در ایجاد حالت شبیه‌سازی: ' + error.message);
                }
            });
            
            // توقف تحلیل صدا
            stopBtn.addEventListener('click', function() {
                if (!isAnalyzing && !isSimulating) return;
                
                // توقف انیمیشن
                cancelAnimationFrame(animationId);
                
                // توقف نوسان‌ساز در حالت شبیه‌سازی
                if (isSimulating && oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                }
                
                // بستن context صوتی
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // تغییر وضعیت دکمه‌ها
                startBtn.disabled = false;
                stopBtn.disabled = true;
                simulateBtn.disabled = false;
                isAnalyzing = false;
                isSimulating = false;
                
                processingMode.textContent = "متوقف شده";
                
                // پاک کردن Canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            // تابع انیمیشن برای رسم طیف
            function animate() {
                if (!isAnalyzing && !isSimulating) return;
                
                // دریافت داده‌های فرکانسی
                analyserLeft.getByteFrequencyData(dataArrayLeft);
                analyserRight.getByteFrequencyData(dataArrayRight);
                
                // پاک کردن Canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // محاسبه عرض هر میله
                const barWidth = (canvas.width / dataArrayLeft.length) * 2.5;
                let barHeight;
                let x = 0;
                
                // محاسبه فرکانس غالب و سطح صدا
                let maxLeft = 0;
                let maxRight = 0;
                let maxIndexLeft = 0;
                let maxIndexRight = 0;
                let sumLeft = 0;
                let sumRight = 0;
                
                // رسم طیف برای کانال چپ
                for (let i = 0; i < dataArrayLeft.length; i++) {
                    barHeight = dataArrayLeft[i] / 2;
                    
                    // یافتن فرکانس غالب
                    if (dataArrayLeft[i] > maxLeft) {
                        maxLeft = dataArrayLeft[i];
                        maxIndexLeft = i;
                    }
                    
                    sumLeft += dataArrayLeft[i];
                    
                    // رسم میله
                    const hue = i / dataArrayLeft.length * 360;
                    ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
                
                // رسم طیف برای کانال راست
                x = 0;
                for (let i = 0; i < dataArrayRight.length; i++) {
                    barHeight = dataArrayRight[i] / 2;
                    
                    // یافتن فرکانس غالب
                    if (dataArrayRight[i] > maxRight) {
                        maxRight = dataArrayRight[i];
                        maxIndexRight = i;
                    }
                    
                    sumRight += dataArrayRight[i];
                    
                    // رسم میله با شفافیت برای ترکیب با کانال چپ
                    const hue = 240 + (i / dataArrayRight.length * 120);
                    ctx.fillStyle = `hsla(${hue}, 100%, 60%, 0.7)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
                
                // محاسبه و نمایش فرکانس غالب
                const sampleRate = audioContext ? audioContext.sampleRate : 44100;
                const freqLeft = maxIndexLeft * sampleRate / analyserLeft.fftSize;
                const freqRight = maxIndexRight * sampleRate / analyserRight.fftSize;
                dominantFrequency.textContent = `${Math.round((freqLeft + freqRight) / 2)} Hz`;
                
                // محاسبه و نمایش سطح شدت صوت
                const avgLeft = sumLeft / dataArrayLeft.length;
                const avgRight = sumRight / dataArrayRight.length;
                const dbValue = 20 * Math.log10((avgLeft + avgRight) / 2 / 128);
                volumeLevel.textContent = `${dbValue.toFixed(1)} dB`;
                
                // درخواست فریم انیمیشن بعدی
                animationId = requestAnimationFrame(animate);
            }
            
            // بررسی پشتیبانی از getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('مرورگر شما از دسترسی به میکروفون پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.');
                startBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
